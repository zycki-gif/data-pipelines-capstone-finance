{"commands": [{"bindings": {}, "collapsed": false, "command": "\n%md\n# Dataset-Mounts-Test\nThe purpose of this notebook is to faciliate testing of our systems.", "commandTitle": "", "commandType": "auto", "commandVersion": 0, "commentThread": [], "commentsVisible": false, "customPlotOptions": {}, "datasetPreviewNameToCmdIdMap": {}, "diffDeletes": [], "diffInserts": [], "displayType": "table", "error": null, "errorSummary": null, "finishTime": 0, "globalVars": {}, "guid": "eb4ffaa1-1bc3-413b-8ce1-1ebab3074e60", "height": "auto", "hideCommandCode": false, "hideCommandResult": false, "iPythonMetadata": null, "inputWidgets": {}, "latestUser": "", "latestUserId": null, "nuid": "22e451f6-6060-4b4b-ab51-3a9f05034e34", "origId": 0, "parentHierarchy": [], "pivotAggregation": null, "pivotColumns": null, "position": 1, "results": null, "showCommandTitle": false, "startTime": 0, "state": "finished", "streamStates": {}, "submitTime": 0, "subtype": "command", "version": "CommandV1", "width": "auto", "workflows": [], "xColumns": null, "yColumns": null}, {"bindings": {}, "collapsed": false, "command": "spark.conf.set(\"com.databricks.training.module-name\", \"dataset-mounts-test\")", "commandTitle": "", "commandType": "auto", "commandVersion": 0, "commentThread": [], "commentsVisible": false, "customPlotOptions": {}, "datasetPreviewNameToCmdIdMap": {}, "diffDeletes": [], "diffInserts": [], "displayType": "table", "error": null, "errorSummary": null, "finishTime": 0, "globalVars": {}, "guid": "bf49caff-a5c4-4466-b452-c83003b9cea9", "height": "auto", "hideCommandCode": false, "hideCommandResult": false, "iPythonMetadata": null, "inputWidgets": {}, "latestUser": "", "latestUserId": null, "nuid": "d3d76556-faa9-4e5c-8d8a-6f50a712dce3", "origId": 0, "parentHierarchy": [], "pivotAggregation": null, "pivotColumns": null, "position": 2, "results": null, "showCommandTitle": false, "startTime": 0, "state": "finished", "streamStates": {}, "submitTime": 0, "subtype": "command", "version": "CommandV1", "width": "auto", "workflows": [], "xColumns": null, "yColumns": null}, {"bindings": {}, "collapsed": false, "command": "%run ./Dataset-Mounts", "commandTitle": "", "commandType": "auto", "commandVersion": 0, "commentThread": [], "commentsVisible": false, "customPlotOptions": {}, "datasetPreviewNameToCmdIdMap": {}, "diffDeletes": [], "diffInserts": [], "displayType": "table", "error": null, "errorSummary": null, "finishTime": 0, "globalVars": {}, "guid": "2232be14-377c-451e-9af2-3e5ab8f96c16", "height": "auto", "hideCommandCode": false, "hideCommandResult": false, "iPythonMetadata": null, "inputWidgets": {}, "latestUser": "", "latestUserId": null, "nuid": "e9064e1f-b61d-451a-b47a-9f9661cb670c", "origId": 0, "parentHierarchy": [], "pivotAggregation": null, "pivotColumns": null, "position": 3, "results": null, "showCommandTitle": false, "startTime": 0, "state": "finished", "streamStates": {}, "submitTime": 0, "subtype": "command", "version": "CommandV1", "width": "auto", "workflows": [], "xColumns": null, "yColumns": null}, {"bindings": {}, "collapsed": false, "command": "%scala\n\nval testStart = System.currentTimeMillis\nval mountPointBase = \"/mnt/training-test\"\n\ndef unmount(mountPoint:String):Unit = {\n  try {\n    dbutils.fs.unmount(mountPoint)\n  } catch {\n    case e:Exception => println(s\"Not mounted: $mountPoint\")\n  }\n}\n\ndef testRegion(regionType:String, regionName:String, mapper: (String) => (String,Map[String,String])):Unit = {\n  val start = System.currentTimeMillis\n  \n  val (source, extraConfigs) = mapper(regionName)\n  val mountPoint = s\"$mountPointBase-${regionType.toLowerCase}-$regionName\"\n  println(s\"\"\"\\nTesting the $regionType region $regionName ($mountPoint)\"\"\")\n\n  mountSource(true, false, mountPoint, source, extraConfigs)\n  Thread.sleep(5*1000) // give it a second\n  validateDatasets(mountPoint)\n  \n  val duration = (System.currentTimeMillis - start) / 1000.0\n  println(f\"...all tests passed in $duration%1.2f seconds!\")\n}\n\ndef validateDataset(mountPoint:String, target:String):Unit = {\n  val map = scala.collection.mutable.Map[String,(Long,Long)]()\n  for (file <- dbutils.fs.ls(s\"/mnt/training/$target\")) {\n    map.put(file.name, (file.size, -1L))\n  }\n\n  val path = s\"$mountPoint/$target\"\n  for (file <- dbutils.fs.ls(path)) {\n      if (map.contains(file.name)) {\n        val (sizes, _) = map(file.name)\n        map.put(file.name, (sizes, file.size))\n      } else {\n        map.put(file.name, (-1, file.size))\n      }\n  }\n  \n  var errors = \"\"\n  for (key <- map.keySet) {\n    val (sizeA, sizeB) = map(key)\n    if (sizeA == sizeB) {\n      // Everything matches up... no issue here.\n    } else if (sizeA == -1) {\n      if (!key.endsWith(\"_$folder$\"))\n        errors += s\"Extra file: $path$key\\n\"\n    } else if (sizeB == -1) {\n      errors += s\"Missing file: $path$key\\n\"\n    }\n  }\n  \n  errors = errors.trim()\n  if (errors != \"\") {\n    println(errors)\n    throw new IllegalStateException(s\"Errors were found while processing $path\")\n  }\n}\n\n\ndef validateDatasets(mountPoint:String) {\n  val paths = List(\n    \"\",\n    \"301/\",\n    \"Chicago-Crimes-2018.csv\",\n    \"City-Data.parquet/\",\n    \"EDGAR-Log-20170329/\",\n    \"UbiqLog4UCI/\",\n    \"_META/\",\n    \"adventure-works/\",\n    \"airbnb/\",\n    \"airbnb-sf-listings.csv\",\n    \"asa/\",\n    \"auto-mpg.csv\",\n    \"bigrams/\",\n    \"bikeSharing/\",\n    \"bostonhousing/\",\n    \"cancer/\",\n    \"countries/\",\n    \"crime-data-2016/\",\n    \"data/\",\n    \"data-cleansing/\",\n    \"databricks-blog.json\",\n    \"databricks-datasets/\",\n    \"dataframes/\",\n    \"day-of-week/\",\n    \"definitive-guide/\",\n    \"dl/\",\n    \"gaming_data/\",\n    \"global-sales/\",\n    \"graphx-demo/\",\n    \"initech/\",\n    \"ip-geocode.parquet/\",\n    \"iris/\",\n    \"mini_newsgroups/\",\n    \"mnist/\",\n    \"movie-reviews/\",\n    \"movielens/\",\n    \"movies/\",\n    \"online_retail/\",\n    \"philadelphia-crime-data-2015-ytd.csv\",\n    \"purchases.txt\",\n    \"sensor-data/\",\n    \"ssn/\",\n    \"stopwords\",\n    \"structured-streaming/\",\n    \"test.log\",\n    \"tom-sawyer/\",\n    \"tweets.txt\",\n    \"twitter/\",\n    \"wash_dc_crime_incidents_2013.csv\",\n    \"wash_dc_crime_incidents_2015-10-03-to-2016-10-02.csv\",\n    \"weather/\",\n    \"wikipedia/\",\n    \"wine.parquet/\",\n    \"word-game-dict.txt\",\n    \"zip3state.csv\",\n    \"zips.json\"\n  )\n  for (path <- paths) {\n    validateDataset(mountPoint, path)\n  }\n}", "commandTitle": "", "commandType": "auto", "commandVersion": 0, "commentThread": [], "commentsVisible": false, "customPlotOptions": {}, "datasetPreviewNameToCmdIdMap": {}, "diffDeletes": [], "diffInserts": [], "displayType": "table", "error": null, "errorSummary": null, "finishTime": 0, "globalVars": {}, "guid": "60cc81e5-f71c-4789-b615-5e0b462a1e3c", "height": "auto", "hideCommandCode": false, "hideCommandResult": false, "iPythonMetadata": null, "inputWidgets": {}, "latestUser": "", "latestUserId": null, "nuid": "c2270e7f-a882-449a-944c-02a38105a79e", "origId": 0, "parentHierarchy": [], "pivotAggregation": null, "pivotColumns": null, "position": 4, "results": null, "showCommandTitle": false, "startTime": 0, "state": "finished", "streamStates": {}, "submitTime": 0, "subtype": "command", "version": "CommandV1", "width": "auto", "workflows": [], "xColumns": null, "yColumns": null}, {"bindings": {}, "collapsed": false, "command": "%scala\nval awsRegions=List(\n  \"us-west-2\",\n  \"ap-northeast-1\",\n  \"ap-northeast-2\",\n  \"ap-south-1\",\n  \"ap-southeast-1\",\n  \"ap-southeast-2\",\n  \"ca-central-1\",\n  \"eu-central-1\",\n  \"eu-west-1\",\n  \"eu-west-2\",\n  \"eu-west-3\",\n  \"sa-east-1\",\n  \"us-east-1\",\n  \"us-east-2\"\n).map(_.toLowerCase())\n\nval azureRegions=List(\n \"AustraliaCentral\",\n \"AustraliaCentral2\",\n \"AustraliaEast\",\n \"AustraliaSoutheast\",\n \"CanadaCentral\",\n \"CanadaEast\",\n \"CentralIndia\",\n \"CentralUS\",\n \"EastAsia\",\n \"EastUS\",\n \"EastUS2\",\n \"JapanEast\",\n \"JapanWest\",\n \"NorthCentralUS\",\n \"NorthCentralUS\",\n \"NorthEurope\",\n \"SouthCentralUS\",\n \"SouthCentralUS\",\n \"SouthIndia\",\n \"SoutheastAsia\",\n \"UKSouth\",\n \"UKWest\",\n \"WestCentralUS\",  // Azure Databricks isn't available in region, but we historically copied data here anyway.\n \"WestEurope\",\n \"WestIndia\",\n \"WestUS\",\n \"WestUS2\"\n).map(_.toLowerCase())", "commandTitle": "", "commandType": "auto", "commandVersion": 0, "commentThread": [], "commentsVisible": false, "customPlotOptions": {}, "datasetPreviewNameToCmdIdMap": {}, "diffDeletes": [], "diffInserts": [], "displayType": "table", "error": null, "errorSummary": null, "finishTime": 0, "globalVars": {}, "guid": "741bc6e5-c102-40b6-9d7e-2c0d84c76f97", "height": "auto", "hideCommandCode": false, "hideCommandResult": false, "iPythonMetadata": null, "inputWidgets": {}, "latestUser": "", "latestUserId": null, "nuid": "225d85fa-41c6-4f47-ba63-c5df5e41b2e0", "origId": 0, "parentHierarchy": [], "pivotAggregation": null, "pivotColumns": null, "position": 5, "results": null, "showCommandTitle": false, "startTime": 0, "state": "finished", "streamStates": {}, "submitTime": 0, "subtype": "command", "version": "CommandV1", "width": "auto", "workflows": [], "xColumns": null, "yColumns": null}, {"bindings": {}, "collapsed": false, "command": "%scala\nfor (region <- awsRegions) {\n  testRegion(\"AWS\", region, getAwsMapping _)\n}", "commandTitle": "", "commandType": "auto", "commandVersion": 0, "commentThread": [], "commentsVisible": false, "customPlotOptions": {}, "datasetPreviewNameToCmdIdMap": {}, "diffDeletes": [], "diffInserts": [], "displayType": "table", "error": null, "errorSummary": null, "finishTime": 0, "globalVars": {}, "guid": "6b3f73b6-54ef-47f2-bd4b-44dd44d27100", "height": "auto", "hideCommandCode": false, "hideCommandResult": false, "iPythonMetadata": null, "inputWidgets": {}, "latestUser": "", "latestUserId": null, "nuid": "d7022a15-e332-4ddf-8a07-b0c9aa5a9393", "origId": 0, "parentHierarchy": [], "pivotAggregation": null, "pivotColumns": null, "position": 6, "results": null, "showCommandTitle": false, "startTime": 0, "state": "finished", "streamStates": {}, "submitTime": 0, "subtype": "command", "version": "CommandV1", "width": "auto", "workflows": [], "xColumns": null, "yColumns": null}, {"bindings": {}, "collapsed": false, "command": "%python\nfor mount in (mount[0] for mount in dbutils.fs.mounts() if \"training-test\" in mount[0]):\n  dbutils.fs.unmount(mount)", "commandTitle": "", "commandType": "auto", "commandVersion": 0, "commentThread": [], "commentsVisible": false, "customPlotOptions": {}, "datasetPreviewNameToCmdIdMap": {}, "diffDeletes": [], "diffInserts": [], "displayType": "table", "error": null, "errorSummary": null, "finishTime": 0, "globalVars": {}, "guid": "b0c81b30-8ccf-4522-9696-c70b5b8a5a45", "height": "auto", "hideCommandCode": false, "hideCommandResult": false, "iPythonMetadata": null, "inputWidgets": {}, "latestUser": "", "latestUserId": null, "nuid": "cf127a8f-36b5-4a0d-bcf0-7bbda25382a3", "origId": 0, "parentHierarchy": [], "pivotAggregation": null, "pivotColumns": null, "position": 7, "results": null, "showCommandTitle": false, "startTime": 0, "state": "finished", "streamStates": {}, "submitTime": 0, "subtype": "command", "version": "CommandV1", "width": "auto", "workflows": [], "xColumns": null, "yColumns": null}, {"bindings": {}, "collapsed": false, "command": "%scala\nfor (region <- azureRegions) {\n  testRegion(\"Azure\", region, getAzureMapping _)\n}", "commandTitle": "", "commandType": "auto", "commandVersion": 0, "commentThread": [], "commentsVisible": false, "customPlotOptions": {}, "datasetPreviewNameToCmdIdMap": {}, "diffDeletes": [], "diffInserts": [], "displayType": "table", "error": null, "errorSummary": null, "finishTime": 0, "globalVars": {}, "guid": "1da6064d-6db1-4192-b874-f8b20d88244f", "height": "auto", "hideCommandCode": false, "hideCommandResult": false, "iPythonMetadata": null, "inputWidgets": {}, "latestUser": "", "latestUserId": null, "nuid": "2af6e3fa-a7f0-4e09-b057-b402bbe0274f", "origId": 0, "parentHierarchy": [], "pivotAggregation": null, "pivotColumns": null, "position": 8, "results": null, "showCommandTitle": false, "startTime": 0, "state": "finished", "streamStates": {}, "submitTime": 0, "subtype": "command", "version": "CommandV1", "width": "auto", "workflows": [], "xColumns": null, "yColumns": null}, {"bindings": {}, "collapsed": false, "command": "%scala\nprintln(f\"...all tests passed in ${(System.currentTimeMillis - testStart) / 1000.0 / 60.0}%1.2f minutes!\")", "commandTitle": "", "commandType": "auto", "commandVersion": 0, "commentThread": [], "commentsVisible": false, "customPlotOptions": {}, "datasetPreviewNameToCmdIdMap": {}, "diffDeletes": [], "diffInserts": [], "displayType": "table", "error": null, "errorSummary": null, "finishTime": 0, "globalVars": {}, "guid": "6882f17a-e528-4133-ad83-0d15942d638b", "height": "auto", "hideCommandCode": false, "hideCommandResult": false, "iPythonMetadata": null, "inputWidgets": {}, "latestUser": "", "latestUserId": null, "nuid": "0705931b-fe77-4c6d-ab2e-ad42eedb13f5", "origId": 0, "parentHierarchy": [], "pivotAggregation": null, "pivotColumns": null, "position": 9, "results": null, "showCommandTitle": false, "startTime": 0, "state": "finished", "streamStates": {}, "submitTime": 0, "subtype": "command", "version": "CommandV1", "width": "auto", "workflows": [], "xColumns": null, "yColumns": null}, {"bindings": {}, "collapsed": false, "command": "%python\nfor mount in (mount[0] for mount in dbutils.fs.mounts() if \"training-test\" in mount[0]):\n  dbutils.fs.unmount(mount)\n", "commandTitle": "", "commandType": "auto", "commandVersion": 0, "commentThread": [], "commentsVisible": false, "customPlotOptions": {}, "datasetPreviewNameToCmdIdMap": {}, "diffDeletes": [], "diffInserts": [], "displayType": "table", "error": null, "errorSummary": null, "finishTime": 0, "globalVars": {}, "guid": "cd1b5bd2-3e05-4231-bdca-988e8de3f230", "height": "auto", "hideCommandCode": false, "hideCommandResult": false, "iPythonMetadata": null, "inputWidgets": {}, "latestUser": "", "latestUserId": null, "nuid": "0a808247-35bc-461a-be51-6a3990bbf700", "origId": 0, "parentHierarchy": [], "pivotAggregation": null, "pivotColumns": null, "position": 10, "results": null, "showCommandTitle": false, "startTime": 0, "state": "finished", "streamStates": {}, "submitTime": 0, "subtype": "command", "version": "CommandV1", "width": "auto", "workflows": [], "xColumns": null, "yColumns": null}], "dashboards": [], "globalVars": {}, "guid": "22da6f69-15d3-4fdf-b320-bc2f58ac3f81", "iPythonMetadata": null, "inputWidgets": {}, "language": "python", "name": "Dataset-Mounts-Test", "origId": 0, "version": "NotebookV1"}